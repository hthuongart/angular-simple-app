<div class="container mx-auto p-4" (click)="contextMenu.set(null)">
    <div class="flex gap-4 mb-4">
      <input #start type="month" [value]="startDate() | date:'yyyy-MM'" 
             (change)="onDateChange(start, end)" class="p-2 border rounded">
      <input #end type="month" [value]="endDate() | date:'yyyy-MM'" 
             (change)="onDateChange(start, end)" class="p-2 border rounded">
    </div>
  
    <table class="w-full border-collapse border">
      <thead>
        <tr>
          <th class="p-2 border bg-gray-100">Categories</th>
          <th *ngFor="let month of months()" class="p-2 border bg-gray-100">
            {{ month | date:'MMM' }}
          </th>
        </tr>
      </thead>
  
      <tbody>
        <!-- 1. Category begin -->
        <ng-container *ngFor="let category of categories()">
          <!-- 1.1. Category name begin -->
          <tr>
              <td class="border p-2 font-bold" [attr.colspan]="months().length + 1"
              *ngFor="let cell of category.cells; let categoryColIndex = index">{{ cell.value }}</td>
          </tr>
          <!-- 1.1. Caegory name end -->

          <!-- 2. SubCategory begin -->
          <ng-container *ngFor="let subCategory of category.subCategories">
            <!-- 2.1. SubCategory name begin -->
            <tr *ngIf="!subCategory.isNew">
              <td class="border p-2 font-bold" [attr.colspan]="months().length + 1"
              *ngFor="let cell of subCategory.cells">{{ cell.value }}</td>
            </tr>
            <!-- 2.1. SubCategory name end -->


            <!-- 3. SubSubCategory begin -->
            <ng-container *ngFor="let subSubCategory of subCategory.subCategories">
              <!-- 3.1. SubSubCategory begin -->
              <tr *ngIf="!subSubCategory.isNew">
                <ng-container *ngFor="let cell of subSubCategory.cells; let subSubCategoryColIndex = index">
                  <!-- 3.1.1. SubSubCategory name begin -->
                  <td class="border p-2"
                  *ngIf="!cell.allowFocus">{{ cell.value }}</td>
                  <!-- 3.1.1. SubSubCategory name end -->
                  
                  <!-- 3.1.2. SubSubCategory monthly begin -->
                  <td *ngIf="cell.allowFocus && subSubCategoryColIndex < months().length + 1" class="border p-2">
                    <input type="number" 
                    #cellInput
                    [(ngModel)]="cell.value"
                    (ngModelChange)="onCellChange(subSubCategory, subSubCategoryColIndex)"
                    (contextmenu)="onCellRightClick($event, subSubCategory, subSubCategoryColIndex)"
                    (keydown)="onCellKeyDown($event, subSubCategory, subCategory.id)"
                    (focus)="onCellFocus()"
                    class="w-full bg-transparent text-right"/>
                  </td>
                  <!-- 3.1.2. SubSubCategory monthly end -->
                </ng-container>

                <!-- 3.1.3 SubSubCategory delete begin -->
                <td class="p-2 border">
                  <button (click)="deleteCategory(subSubCategory.id)" class="text-red-500 hover:text-red-700">
                    âœ•
                  </button>
                </td>
                <!-- 3.1.3. SubSubCategory delete end -->
              </tr>
              <!-- 3.1. SubSubCategory end -->

              <!-- 3.2. SubSubCategory add new begin -->
              <tr *ngIf="subSubCategory.isNew">
                <td class="border p-2" [attr.colspan]="months().length + 1"
                *ngFor="let cell of subSubCategory.cells">
                  <input type="text"
                  #cellInput 
                  [(ngModel)]="cell.value"
                  (keydown)="onCellKeyDown($event, subSubCategory, subCategory.id)"
                  (focus)="onCellFocus()"
                  class="p-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  style="width: 90%;"/>
                </td>
              </tr>
              <!-- 3.2. SubSubCategory add new end -->
            </ng-container>
            <!-- 3. SubSubCategory end -->

            <!-- 2.2. SubCategory total begin -->
            <tr *ngIf="!subCategory.isNew">
              <ng-container *ngFor="let subTotal of subCategory.subTotals; let subTotalColIndex = index;">
                <td class="border p-2 font-bold"
                *ngIf="subTotalColIndex == 0">Sub Total</td>

                <td  class="p-2 border font-bold text-right"
                *ngIf="subTotalColIndex > 0 && subTotalColIndex < months().length + 1">{{ subTotal }}</td>
              </ng-container>
            </tr>
            <!-- 2.2. SubCategory total end -->
            
            <tr *ngIf="subCategory.isNew">
              <td class="border p-2" [attr.colspan]="months().length + 1"
                *ngFor="let cell of subCategory.cells">
                  <input type="text"
                  #cellInput 
                  [(ngModel)]="cell.value"
                  (keydown)="onCellKeyDown($event, subCategory, category.id)"
                  (focus)="onCellFocus()"
                  class="p-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  style="width: 90%;"/>
                </td>
            </tr>

            <!-- Beak line -->
            <tr><td class="border p-2 font-bold" [attr.colspan]="months().length + 1"></td></tr>
          </ng-container>
          <!-- 2. SubCategory end -->

          <!-- 1.2. Category total begin -->
          <tr>
            <ng-container *ngFor="let subTotal of category.subTotals; let subTotalColIndex = index;">
              <td class="border p-2 font-bold"
              *ngIf="subTotalColIndex == 0">{{category.name}} Total</td>

              <td  class="p-2 border font-bold text-right"
              *ngIf="subTotalColIndex > 0 && subTotalColIndex < months().length + 1">{{ subTotal }}</td>
            </ng-container>
          </tr>
          <!-- 1.2. Category total end -->

          <!-- Beak line -->
          <tr><td class="border p-2 font-bold" [attr.colspan]="months().length + 1"></td></tr>

        </ng-container>
        <!-- 1. Category end -->

        <!-- Region Totals -->
        <tr class="bg-red-50">
          <td class="p-2 border font-bold">Profit / Loss</td>
          <ng-container *ngFor="let profitLoss of totals().profitLoss; let i = index;">
            <td *ngIf="i > 0 && i < months().length + 1" class="p-2 border font-bold text-right">
              {{ profitLoss | number }}
            </td>
          </ng-container>
        </tr>

        <tr class="bg-green-50">
          <td class="p-2 border font-bold">Opening Balance</td>
          <ng-container *ngFor="let balance of totals().openingBalance; let i = index;">
            <td  *ngIf="i > 0 && i < months().length + 1" class="p-2 border font-bold text-right">
              {{ balance | number }}
            </td>
          </ng-container>
        </tr>

        <tr class="bg-green-50">
          <td class="p-2 border font-bold">Closing Balance</td>
          <ng-container *ngFor="let balance of totals().closingBalance; let i = index;">
            <td  *ngIf="i > 0 && i < months().length + 1" class="p-2 border font-bold text-right">
              {{ balance | number }}
            </td>
          </ng-container>
        </tr>
        <!-- End Region-->

      </tbody>
    </table>
  
    <!-- Context Menu -->
  <div *ngIf="contextMenu() as ctx" 
  class="fixed bg-white shadow-lg rounded border border-gray-200"
  [style.left.px]="ctx.x" 
  [style.top.px]="ctx.y">
    <div class="p-2 hover:bg-gray-100 cursor-pointer" (click)="applyToAll()">
      Apply to All
    </div>
  </div>


  </div>